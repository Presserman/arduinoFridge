#include <LiquidCrystal.h>
LiquidCrystal lcd(7, 6, 5, 4, 3, 2);
int lightSensor = A0;
int tempRead = A1;
int doorClosed = true;
int doorOpenedRecently = true;
int lightValue = 0;
int beerDelayCount = 0;
int beerDisplayFinished = false;
int beerInFridge = false;
int tempDelayCount;

void setup() {
  Serial.begin(9600);
  pinMode(lightSensor, INPUT);
  pinMode(tempRead, INPUT);
  lcd.begin(16, 2);
}

void loop() {
  
  beerLoopBegin:
  // Light evaluation
  // Periodically displayed on Shield
  
  if(doorClosed && doorOpenedRecently){ // Get light value
    lightValue = analogRead(lightSensor);
    //Serial.println(lightValue, DEC);
    doorOpenedRecently = false;
  }
  else{
    // won't work
  }
  
  if(lightValue > 0){ // Use light value for evaluations
    // Print "no beer in fridge" on display
    beerInFridge = false;
    delay(10); // Wait for the user to read the message, go forward after
  }
  else{
    beerInFridge = true;
  }

  if(beerDelayCount <= 500 && beerInFridge){
    beerDelayCount += 1;
    goto beerLoopBegin;
  }
  tempDelayCount = 0;
  tempLoopBegin:
  
  // Temperature evaluation
  // Mostly displayed on Shield
  
  Serial.print("Temperatura: ");
  float temperatura = readTempInCelsius(10,tempRead);
  Serial.print(temperatura); // Print to display
  Serial.print("  "); // Print to display
  Serial.write(176); // Print to display
  Serial.println("C"); // Print to display

  //Shield display
  
  lcd.setCursor(0, 0);
  lcd.print("Temperatura");
  lcd.setCursor(0, 1);
  lcd.print(temperatura );
  lcd.setCursor(5, 1);
  lcd.print((char)176);
  lcd.setCursor(6, 1);
  lcd.print('C');
  
  delay(10);
  
  if(tempDelayCount <= 500){
    goto tempLoopBegin;
  }
  
  if(beerInFridge){
    beerDelayCount = 0;
  }
  
  
  // To add engine code here

  // To add LED cipher code here

}

// Celsius converter function

float readTempInCelsius(int count, int pin) {
  float temperaturaMediata = 0;
  float sumaTemperatura = 0;
  for (int i =0; i < count; i++) {
    int reading = analogRead(pin);
    float voltage = reading * 5.0;
    voltage /= 1024.0;
    float temperatureCelsius = (voltage - 0.5) * 100 ;
    sumaTemperatura = sumaTemperatura + temperatureCelsius;
  }
  return sumaTemperatura / (float)count;
}
